<!DOCTYPE html>
<html lang="en" xml:lang="en" class="" xmlns="http://www.w3.org/1999/xhtml">
<head>
<!--Google Meta-->
<title><%= @social_title %></title>
<meta name="description" content="<%= @social_descrip %>"/>

<!--Facebook Meta Infomation-->

<meta property="og:title" content="<%= @social_title %>"/>
<meta property="og:type" content="band"/>
<meta property="og:url" content="<%= @social_fb_url %>"/>
<meta property="og:image" content="<%= @social_image %>"/>
<meta property="og:site_name" content="Three Repeater"/>
<meta property="fb:admins" content="513047468"/>
<meta property="og:description" content="<%= @social_descrip %>"/>

<!--Twitter Metta Info-->
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@3rptr">
<meta name="twitter:creator" content="<%= @social_twitter_name %>">
<meta name="twitter:url" content="<%= url_for(:only_path => false) %>">
<meta name="twitter:title" content="<%= @social_title %>">
<meta name="twitter:description" content="<%= @social_descrip %>">
<meta name="twitter:image" content="<%= @social_image %>">

<meta class="area">

<link type="text/css" rel="stylesheet" href="/<%= @artist.url_slug %>/css" media="screen">


<%= stylesheet_link_tag :all %>

<!--defaults-->
<%#= javascript_include_tag :'defaults'%>
<!--/defaults-->

<%= javascript_include_tag 'jquery-1.8.3', 'rails.validations', 'jquery.backstretch.min', 'showHide' %>
<%#= javascript_include_tag 'jquery-1.6.3','rails.validations', 'jquery.backstretch.min'%>

<script type="text/javascript" src="/javascripts/jPlayer/jquery.jplayer.min.js"></script>
<script type="text/javascript" src="/javascripts/jPlayer/add-on/jplayer.playlist.min.js"></script>
<script type="text/javascript" src="/javascripts/jPlayer/add-on/jquery.jplayer.inspector.js"></script>
<link type="text/css" href="/skin/black_and_yellow/jplayer-black-and-yellow.css" rel="stylesheet"/>
<link type="text/css" href="/stylesheets/style.css" rel="stylesheet"/>
<!-- Twitter follow -->
<script type="text/javascript" src="https://platform.twitter.com/widgets.js"></script>

<!-- Master template -->
<script>//<![CDATA[
$(function () {
	$.backstretch("<%=@artist.image_url.to_s%>");

	$('.show_hide').showHide({
		speed:300, // speed you want the toggle to happen
		easing:'', // the animation effect you want. Remove this line if you dont want an effect and if you haven't included jQuery UI
		changeText:0, // if you dont want the button text to change, set this to 0
		showText:'View', // the button text to show when a div is closed
		hideText:'Close' // the button text to show when a div is open

	});
});


//<!-- Global Varaibles for playing song in playlist with click -->
var myPlaylist;
var playlistSongs = [];
var artistSongs = {};

//<!-- Initializes the play list -->
function initializePlayList(newPlaylist) {

	return new jPlayerPlaylist({
				jPlayer:"#jquery_jplayer_1",
				cssSelectorAncestor:"#jp_container_1"
			},
			newPlaylist,
			{playlistOptions:{
				autoPlay:true
			}},
			{
				swfPath:"../javascripts/jplayer",
				supplied:"mp3",
				wmode:"window"
			});
}

function songCountIncrementer(event) {
	console.log(event);
	var songID = event.jPlayer.status.media.songID || null;

	if(songID == null) return;

	$.ajax("/api/incrementPlayCount/" + songID, {
		success : function(data){
		console.log("SUCCESSFUL COUNT INCREMENT");
		console.log(data);
	}

	});
}

var DEBUGGING = true;
$(document).ready(function () {

	myPlaylist = initializePlayList(playlistSongs);

	/*song play counts*/
	$("#jquery_jplayer_1").on($.jPlayer.event.ended, songCountIncrementer);

	//<!-- Click Handler to add song to playlist.Songs are stored in Artists, Index's are assocated with songs -->

	$(".music-button").live("click", function (event) {
		event.preventDefault();

		//<!-- Assigns varibles from click-->
		var songName = $(this).attr('data-song-name'),
			artistName = $(this).attr('data-artist-name'),
			songID = $(this).attr('data-song-id');

		//<!-- checks to see if artist already exisits in the playlist -->
		if (artistSongs[artistName] == undefined)
			artistSongs[artistName] = {};
		//<!-- Assigns the song index to varaible songindex, if it does not exist then become undefined and will be added below -->
		var songIndex = artistSongs[artistName][songName];

		//<!-- If undefined then will ad the song to the play list -->
		if (songIndex === undefined) {
			//<!-- Creates play list object and ads it to play list.If you need to add more song attributes, or file types this is where you do it -->
			myPlaylist.add({
				title:songName,
				artist:artistName,
				songID: songID,
				mp3:$(this).attr('href')
			});

			//<!-- sets the song index. By take the length of the playist (with the song added see above) and subtracts 1 because index starts at 0, length starts at 1 -->
			songIndex = artistSongs[artistName][songName] = myPlaylist.playlist.length - 1;
		}
		artistSong = artistName + "&mdash;" + songName
		myPlaylist.play(songIndex);
		$("#track_name").html(artistSong);


	});

	setTimeout(function () {
		ted_log("about to hit window event listersetTimeout")
		window.addEventListener('popstate', popstate(), false);
	}, 1000);

   //Adds the class selected to link selected...adds arrow below
	$(".content-link .nav").live("click", function (event) {
		$(".content-link .nav").removeClass("selected");
		$(this).addClass("selected");
		event.preventDefault();
	});

	$(".content-link").live("click", function (event) {



		<% if browser.ie? %>
		alert("Music will stop playing, do you wish to continue? To stop this from appearing download chrome.")
		<% else %>
		event.preventDefault();
		url = $(this).attr('href');
		console.log("pathname: " + url);
		ted_log("about to load content in content link")
		loadContent(url);


		// HISTORY.PUSHSTATE
		history.pushState('', 'New URL: ' + url, url);

		

		<% end %>
	});

//	 	Displays track Info
	$(".trackInfo").live('mouseenter', function () {
		$(this).find(".progressBarContainer").show();
	});

	$(".trackInfo").live('mouseleave', function () {
		$(this).find(".progressBarContainer").hide();
	});

//		Displays playlist

	$(".playlist").live('mouseenter', function () {
		console.log("hover enter");
		$(".jp-playlist").show();
	});

	$(".playlist").live('mouseleave', function () {
		console.log("hover leave");
		$(".jp-playlist").hide();
	});


	// adds playlist
	$(".payment").live("click", function (event) {

			}
	)


	$(".load-playlist").live("click", function (event) {
				event.preventDefault();
				var location = $(this).attr('href')

				console.log("location: " + location)
				get_playlist(location);

			}
	)



});

//	Loads Facebook like button script after ajax call
$(document).ajaxComplete(function () {
	try {
		FB.XFBML.parse();
	} catch (ex) {
	}
});

function get_playlist(href) {
//      To display current song info in the player the below code needs to be added jplayer.playlist.min.js in the "_highlight:" function
//		var trackInfo = (this.playlist[a].artist)+"&mdash;"+(this.playlist[a].title)
//		$("#track_name").html(trackInfo);


	$.ajax({
		url:href,
		success:function (json) {
			ted_log(json);
			myPlaylist.setPlaylist(json["playlist"])
		},
		dataType:"json"
	});
}

function popstate() {
	// BACK/FORWARD BUTTONS WORK AS WELL
	window.onpopstate = function (event) {
		ted_log("POPSTATE!");
		console.log(event);
		$("#loading").show();
		var location = window.location.href + "?redir=true";
		ted_log("location: " + location);
		ted_log("about to load content");
		ted_log(location);
		loadContent(location);
	};

}


function loadContent(href) {
	ted_log(href);
	$.ajax({

		url:href,
		success:function (json) {
			ted_log(json);
			ted_log("about to load json")
			//debugger;
			//loads twitter script so follow button and the like will load when back button is hit.

			$.getScript("https://platform.twitter.com/widgets.js")

			$.each(json, function (key, value) {
				$(key).html(value);
			});

		},
		dataType:"json"
	});
}

//was for changing meta information on content load
//	function change_meta() {
//		$("meta[name='twitter:card']").attr("content", "<@artist.name")
//
//
//	}


function ted_log() {
	if (typeof console !== undefined && DEBUGGING) {
		console.log(arguments);
	} else if (DEBUGGING) {
		//alert(json);

	}
}

</script>







<%= csrf_meta_tag %>
</head>

<body>

<div id="fb-root"></div>
<script>(function (d, s, id) {
	var js, fjs = d.getElementsByTagName(s)[0];
	if (d.getElementById(id)) return;
	js = d.createElement(s);
	js.id = id;
	js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
	fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<div class="container">
	<div class="player_nav">


		<div id="jquery_jplayer_1" class="jp-jplayer"></div>


		<div id="jp_container_1">
			<div class="jp-type-playlist">
				<div class="jp-audio-container">
					<div class="branding">
						<b><p class="branding">3RPTR</p></b>
					</div>

					<div class="jp-audio">
						<div class="jp-type-single">
							<div id="jp_interface_1" class="jp-interface">

								<ul class="jp-controls">

									<li><a href="#" class="jp-play" tabindex="1" data-icon="&#x27;"></a></li>
									<li><a href="#" class="jp-pause" tabindex="1" data-icon="&#x22;"></a></li>

									<li><a href="#" class="jp-mute" tabindex="1" data-icon="&#x24;"></a></li>
									<li><a href="#" class="jp-unmute" tabindex="1" data-icon="&#x25;"></a></li>
								</ul>

								<div class="trackInfo">
									<div class="track_name" id="track_name">&nbsp;</div>

									<div class="progressBarContainer">
										<div class="endTime">0:00</div>
										<div class="jp-progress-container">
											<div class="jp-seek-bar">
												<div class="jp-play-bar"></div>
											</div>
										</div>

										<div class="jp-current-time"></div>
									</div>
								</div>

								<div class="playlist">
									Playlist
									<div class="jp-playlist">
										<ul class="songList">
											<li class="playlistSong"></li>
										</ul>
									</div>
								</div>


							</div>
						</div>
					</div>

				</div>

				<div class="jp-no-solution">
					<span>Update Required</span>
					To play the media you will need to either update your browser to a recent version or update your
					<a href="http://get.adobe.com/flashplayer/" target="_blank">Flash plugin</a>.
				</div>
				<!--<div class="clearfix"></div>-->
			</div>
		</div>

		<div id="user_nav" class="user_nav">
			<div class="user_nav_info">
				<% if user_signed_in? %>
					Signed in as <%= link_to current_user.email, show_user_path(current_user.id), :class => :nav %>. Not
					you?
					<%= link_to "Sign out", destroy_user_session_path, :class => :nav, :method => :delete %>

				<% else %>
					<%#= render :partial => 'login_form' %>
					<%= link_to "sign in", new_user_session_path %>
					<%= link_to "register", new_user_registration_path %>

				<% end %>
			</div>
			<div class="admin">
				<a href=# class="adminLink" data-icon="&#x23;"></a>
			</div>
		</div>


	</div>


</div>
<!--<div id="loading">-->
<!--<p>Loading..</p>-->
<!--</div>-->

<!--<div class="facebook" style="overflow:visible; display:inline-block; margin: 10px;">-->

<!--</div>-->

<% if flash[:notice] %>
	<div class="notice"><%= flash[:notice] %></div>
<% end %>
<div class="bodyArea">
<div class="floatingContent">
	<div class="artistLogoArea"><a href="/<%= @artist.url_slug %>/?promo=true"><img src="<%= @artist.logo %>" /></a></div>
	<div class="navArea"><a href="/<%= @artist.url_slug %>" class="content-link"><div class="nav <%= (controller.controller_name=='artists'?'selected':'') %>">INFO</div></a><a href="<%= artist_show_songs_path %>" class="content-link"><div class="nav <%= (controller.controller_name=='songs'?'selected':'') %>">SONGS</div></a><a href="<%= artist_show_albums_path %>" class="content-link"><div class="nav <%= (controller.controller_name=='albums'?'selected':'') %>">ALBUMS</div></a>
	</div>
	<div class="miniPage" id="content"><%= yield %></div>
</div>
</div>
</body>
</html>
